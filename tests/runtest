test x"$srcdir" = x && srcdir=.
test x"$builddir" = x && builddir=.

testtool=$builddir/raqm-test$EXEEXT

if test $# = 0; then
	set /dev/stdin
fi

reference=false
if [ x"$1" = x"--reference" ]
then
	reference=true
	shift
fi

fails=0
for filename in "$@"
do
	$reference || echo -ne "Testing $filename...\t"
	$reference && filename=$srcdir/$filename
	cat $filename > $expected

	output=$(mktemp output.XXXXXX)
	$testtool $filename > $output

	result=$(diff -u $expected $output)
	if test "x$result" != "x"
		then
			fails=$((fails+1))
			echo "The diff is:"
			echo "$result"
		fi

	rm -f $expected $output
done

if test $fails != 0; then
	$reference || echo "$fails tests failed."
	exit 1
else
	$reference || echo "All tests passed."
fi
